# Production - matching-service

steps:
  - name: gcr.io/google.com/cloudsdktool/cloud-sdk:slim
    id: Resolve-URLs
    entrypoint: bash
    args:
      - -c
      - |
         COLLAB_URL=$(gcloud run services describe collab-service-production --region=asia-southeast1 --format='value(status.url)')
         QN_URL=$(gcloud run services describe question-service-production --region=asia-southeast1 --format='value(status.url)')
         echo "COLLAB_SERVICE_URL=$$COLLAB_URL" >> urls.env
         echo "QUESTION_SERVICE_URL=$$QN_URL" >> urls.env

  - name: gcr.io/google.com/cloudsdktool/cloud-sdk:slim
    id: Deploy
    entrypoint: bash
    args:
      - -c
      - |
        source urls.env
        gcloud run deploy matching-service-production \
          --image=asia-southeast1-docker.pkg.dev/cs3219-peerprep-g30/peerprep-staging/matching-service:latest \
          --region=asia-southeast1 \
          --platform=managed \
          --allow-unauthenticated \
          --port=8080 \
          --set-env-vars=COLLAB_SERVICE_URL=$$COLLAB_SERVICE_URL,QUESTION_SERVICE_URL=$$QUESTION_SERVICE_URL \
          --memory=512Mi \
          --cpu=1 \
          --min-instances=1 \
          --max-instances=100 \
          --timeout=60
    waitFor: ['Resolve-URLs']

tags:
  - production
  - matching-service

timeout: 900s

