<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collaborative Text Editor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 800px;
            padding: 30px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #666;
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ccc;
        }
        
        .status-indicator.connected {
            background: #4caf50;
            box-shadow: 0 0 8px rgba(76, 175, 80, 0.6);
        }

        .textfield {
            width: 40%;
            margin: 5px;
            margin-left: 0;
            padding: 5px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            font-family: 'Courier New', monospace;
        }

        .button {
            width: 20%;
            padding: 5px;
            margin: 5px;
            margin-left: 0;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            font-family: 'Courier New', monospace;
        }
        
        textarea {
            width: 100%;
            min-height: 400px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            font-family: 'Courier New', monospace;
            resize: vertical;
            transition: border-color 0.3s;
        }
        
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Collaborative Code Editor</h1>
        <div class="status">
            <div class="status-indicator" id="statusIndicator"></div>
            <span id="statusText">Disconnected</span>
        </div>
        <input type="text" id="createSessionID" class="textfield" placeholder="New Session ID">
        <input type="text" id="createUser1" class="textfield" placeholder="User 1 ID">
        <input type="text" id="createUser2" class="textfield" placeholder="User 2 ID">
        <input type="button" id="createSessionButton" class="button" onclick="createSession()" value="Create">

        <input type="text" id="sessionID" class="textfield" placeholder="Join Session">
        <input type="text" id="userID" class="textfield" placeholder="My ID">
        <input type="button" id="connectButton" class="button" onclick="joinSession()" value="Connect">
        <input type="button" id="disconnectButton" class="button" onclick="leaveSession()" value="Disconnect">

        <textarea id="codeEditor" placeholder="Type code here"></textarea>

    </div>
z
    <script>
        const editor = document.getElementById('codeEditor');
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        const joinSessionInput = document.getElementById('sessionID');
        const joinUserInput = document.getElementById('userID');
        const createSessionInput = document.getElementById('createSessionID');
        const createUser1Input = document.getElementById('createUser1');
        const createUser2Input = document.getElementById('createUser2');

        let ws;
        let isUpdating = false;

        function createSession() {
            const sessionId = createSessionInput.value.trim();
            const user1 = createUser1Input.value.trim();
            const user2 = createUser2Input.value.trim();

            // Post request to create a session
            fetch('/createSession', {
                    method: 'POST',
                    headers: {
                        Authorization: 'Bearer abcdxyz',
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        sessionId,
                        user1,
                        user2,
                        lanugage: 'Java',
                        question: 'Do fibonacci sequence'
                    }),
                })
                    .then((res) => {
                        if (res.status === 201) {
                            console.log("Created Session Successfully");
                        } else {
                            console.log("Failed to create session");
                        }
                        return res.json();
                    })
                    .then((data) => {
                        if (data.err) {
                            console.log(data);
                            alert(data.err);
                        }
                    });
        }

        function joinSession() {
            const sessionId = joinSessionInput.value.trim();
            userId = joinUserInput.value.trim();

            if (!sessionId) {
                alert('Please enter a session ID');
                return;
            }

            currentSessionId = sessionId;

            connect();
        }

        function leaveSession() {
            const sessionId = joinSessionInput.value.trim();

            if (!sessionId) {
                alert('Please enter a session ID');
                return;
            }

            currentSessionId = sessionId;

            ws.send(JSON.stringify({
                type: 'leave',
                sessionId: currentSessionId
            }));

            statusIndicator.classList.remove('connected');
            statusText.textContent = 'Disconnected';
        }
        
        function connect() {
            ws = new WebSocket(`ws://${window.location.host}`);
            

            ws.onopen = () => {
                ws.send(JSON.stringify({
                    type: 'join',
                    sessionId: currentSessionId,
                    userId: userId
                }));
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                
                if (data.type === 'JoinSession') {
                    if (data.status === "Success") {
                        console.log('Connected to session');
                        statusIndicator.classList.add('connected');
                        statusText.textContent = 'Connected';
                    } else {
                        console.log('Could not to server');
                    }
                }

                if (data.type === 'init' || data.type === 'update') {
                    isUpdating = true;
                    const cursorPos = editor.selectionStart;
                    editor.value = data.content;
                    editor.setSelectionRange(cursorPos, cursorPos);
                    isUpdating = false;
                }

                if (data.type === 'Error') {
                    console.log('Error has occurred');
                    console.log(data.msg)
                    alert(data.msg);
                }
            };
            
            ws.onclose = (event) => {
                if (event.code === 3000) {
                    console.log('Websocket closed due to invalid credentials');
                    statusIndicator.classList.remove('connected');
                    statusText.textContent = 'Disconnected';
                } else if (event.code === 4000) {
                    console.log('Websocket closed due to end of session or user has left session');
                    statusIndicator.classList.remove('connected');
                    statusText.textContent = 'Disconnected';
                } else {
                    console.log('Unexpected closure of Websocket');
                    statusIndicator.classList.remove('connected');
                    statusText.textContent = 'Reconnecting...';
                    setTimeout(connect, 2000);
                }
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        }
        
        // Send updates to server
        editor.addEventListener('input', () => {
            if (!isUpdating && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'update',
                    content: editor.value
                }));
            }
        });
        
        // connect();
    </script>
</body>
</html>